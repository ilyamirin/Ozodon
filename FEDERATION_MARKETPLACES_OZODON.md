# Федеративные системы, маркетплейсы и Ozodon

Дата: 2025-09-05

Документ описывает основы федеративных систем, сравнение централизованных и децентрализованных (федеративных) маркетплейсов, а также рассматривает проект Ozodon как пример архитектуры и реализации компонентов большой рабочей системы. В документ включены сравнительные таблицы, схемы (ASCII-псевдографика) и большая схема в формате Mermaid, показывающая все внутренние и внешние элементы, включая пока не реализованные.


## 1. Федерации и федеративные системы

Федерация — это способ объединения независимых узлов (серверов), которые обмениваются сообщениями по согласованным протоколам, сохраняя при этом автономию управления данными и политиками.

### 1.1. Цели и задачи
- Суверенность данных и управление локальными политиками.
- Масштабируемость сети за счёт горизонтального расширения числа узлов.
- Устойчивость к отказам и цензуре: нет единой точки отказа.
- Интероперабельность через открытые протоколы (например, ActivityPub).

### 1.2. Плюсы и минусы федерации

| Аспект | Плюсы федерации | Минусы федерации |
|---|---|---|
| Контроль над данными | Локальная политика, собственные правила модерации | Фрагментация правил, неоднородный опыт |
| Надёжность | Нет единой точки отказа, проще локально бэкапить | Координация инцидентов затруднена |
| Масштабирование | Горизонтальное: добавляй новые узлы | Сложнее обеспечить глобальную консистентность |
| Инновации | Узлы могут экспериментировать независимо | Риск несовместимостей при расширениях |
| Безопасность | Локальные усиления, сегментация рисков | Несогласованная поверхность угроз, сложность единой SSO |
| Откровенность рынка | Меньше «арендной платы» платформы | Сложнее единая реклама/монетизация |

### 1.3. Mastodon как пример федерации
Mastodon — социальная сеть на основе ActivityPub. Ключевые свойства:
- Множество независимых инстансов (серверов), объединённых протоколом ActivityPub.
- Пользователь выбирает инстанс по правилам/культуре, но общается с другими инстансами.
- Контент распространяется через «inbox/outbox» потоки, подписки и публичные адреса.

ASCII-схема федерации (упрощённо):

```
+------------------+          +------------------+          +------------------+
|  Instance A      |          |  Instance B      |          |  Instance C      |
|  (Mastodon)      |  <--->   |  (Mastodon)      |  <--->   |  (Mastodon)      |
|                  | Activity |                  | Activity |                  |
|  Users, Posts    |  Pub     |  Users, Posts    |  Pub     |  Users, Posts    |
+---------+--------+          +---------+--------+          +---------+--------+
          ^                              ^                              ^
          |                              |                              |
        Followers                    Followers                      Followers
```


## 2. Современные маркетплейсы: централизованные vs децентрализованные

### 2.1. Определения
- Централизованный маркетплейс: один оператор контролирует данные, правила, поиск, платежи и отношения с продавцами/покупателями.
- Децентрализованный (федеративный) маркетплейс: множество узлов, совместимый протокол обмена (например, ActivityPub), локальные правила и самостоятельные интеграции (платежи, модерация).

### 2.2. Сравнение по ключевым параметрам

| Параметр | Централизованный | Децентрализованный (федерация) |
|---|---|---|
| Владелец данных | Платформа | Продавец/сообщество/узел |
| Поиск и ранжирование | Единая модель, закрытые алгоритмы | Локальные алгоритмы, федеративные индексы |
| Платежи | Встроенные, единые | Множественные интеграции (TON, стейблкоины, банковские шлюзы) |
| Доверие/репутация | Централизованные рейтинги | Граф доверия между участниками и узлами |
| Модерация | Единая политика | Локальные политики узлов, блок-листы, федеративные фильтры |
| Масштабирование | Вертикальное, контроль платформы | Горизонтальное, добавление узлов |
| Отказоустойчивость | Единая точка отказа | Распределённая устойчивость |
| Комиссии/рентинг | Выше, под контролем платформы | Ниже/гибкие, зависят от конкретного узла |
| Инновации | Под контролем платформы | Эксперименты на уровне узлов, совместимость через протокол |

### 2.3. Типовые архитектурные отличия

ASCII-схемы:

Централизованный маркетплейс
```
        +-----------------------------+
        |     Центральная платформа   |
        |  Поиск | Платежи | Логистика |
        |  Рейтинг | Поддержка | Реклама|
        +-----------------------------+
           ^           ^          ^
           |           |          |
      Продавцы      Покупатели  Партнёры
```

Децентрализованный/федеративный маркетплейс
```
+-------------+       +-------------+       +-------------+
| Узел A      | <---- | Протокол    | ----> | Узел B      |
| Поиск A     |       | (ActivityPub)|      | Поиск B     |
| Платежи A   |       +-------------+       | Платежи B   |
+-------------+                               +-----------+
        ^                                            ^
     Продавцы A                                   Продавцы B
        ^                                            ^
     Покупатели A                                Покупатели B
```


## 3. Проект Ozodon как пример большой рабочей системы

Ozodon — прототип федеративного маркетплейса на базе FastAPI и ActivityPub с MongoDB и интеграцией TON-платежей (заглушки/стабы). Проект включает индексатор предложений (Offer), учёт доверия (Trust), поиск и простые фиды, а также эскроу-потоки платежей на TON (симулировано).

### 3.1. Ключевые компоненты (по коду репозитория)
- FastAPI-приложение: `main.py`, маршруты `routes/`.
- Федерация/ActivityPub: `activitypub.py`, `routes.hub` (`/hub/inbox`), репликация `services.hub_service.replicate_to_peers`.
- Индексация предложений: `services.hub_service.index_offer` -> Mongo `hub_offers`.
- Граф доверия: `services.hub_service.index_trust` -> Mongo `hub_trust_log`, простая агрегация репутации в `routes.hub.trust_score`.
- Поиск и ранжирование: `services.hub_service.search_products` (фильтры + смешанный скор цены/доверия).
- Фиды, теги, категории: `routes.hub.feeds_latest`, `tags_top`, `categories`.
- Платежи TON (эскроу): `services.ton_payment.TONPaymentService` + маршруты `create_escrow`, `confirm_payment`, `refund_payment`.
- База данных: MongoDB (`database.py`), асинхронный клиент Motor.

### 3.2. Потоки данных и взаимодействия

ASCII-схема (детально):
```
ПРОДАВЕЦ (узел A)          УЗЕЛ-HUB Ozodon (наш)                   ДРУГИЕ УЗЛЫ
------------------         ----------------------------            -----------------
make_offer() --->          /hub/inbox (Offer)  -----> index_offer -> hub_offers
                           |                                   
                           |--> replicate_to_peers  -----------------------------> /hub/inbox
                           |
ПОКУПАТЕЛЬ  ---- search ---> /hub/search --> search_products -> Mongo (filters, rank)
           <-- результаты ---^                 ^
                              \-- _seller_reputation() -- hub_trust_log -- index_trust <-- /hub/inbox (Trust)

ПЛАТЁЖИ TON:
create_escrow ---> TONPaymentService.create_escrow_deal() [stub]
confirm_delivery -> confirm_delivery() [stub]
request_refund  -> request_refund()  [stub]
```

### 3.3. Применимость как образец для «больших систем»

| Критерий «большой системы» | Как реализовано/демонстрируется в Ozodon |
|---|---|
| Модульность и слои | Разделение на routes/services/models, ActivityPub-helpers, TON-интеграция как отдельный сервис |
| Отказоустойчивость | Заглушки и безопасные фоллбэки (TON отсутствует — система продолжает работать) |
| Масштабирование | Федерация узлов + репликация активностей, горизонтальное расширение |
| Данные и индексы | MongoDB, чёткие коллекции (hub_offers, hub_trust_log), агрегации |
| Репутация и доверие | Пример графа доверия, простая метрика и расширяемость через services.trust_service |
| Поиск и ранжирование | Текст + теги + цена, смешанный скор с учётом доверия |
| Интеграции | TON-платежи как отдельная подсистема с API-уровнем |
| Протоколы | ActivityPub для совместимости с внешними инстансами |
| Эволюция | Возможность включать/выключать части (config), добавлять будущие модули |

### 3.4. Нереализованные/будущие элементы (планируемые блоки)
- Модерация и апелляции (политики узла, фильтры контента, блок-листы).
- Уведомления (email/push/WebSub), webhooks для внешних интеграций.
- Расширенный граф доверия (алгоритмы транзитивного доверия, общие оценщики).
- Аналитика и метрики (Prometheus/Grafana, бизнес-дашборды).
- Маркетинговые инструменты (купоны, рекомендательные модели).
- Логистика/исполнение заказов (трекеры, SLA, возвраты).
- KYC/AML плагины и риск-скоры для платежей.

ASCII-схема целевой архитектуры (включая будущие блоки):
```
                          +-------------------------------+
                          |        Внешние узлы (AP)      |
                          |  ActivityPub: Inbox/Outbox    |
                          +---------------+---------------+
                                          |
                                          v
+-------------------+         +-----------+-----------+          +------------------------+
|  Web/API Gateway  |  --->   |   Hub (FastAPI)      |   --->   | Replication (Peers)    |
| (CORS, AuthN/Z)   |         |  routes.hub, routes  |          | services.hub_service   |
+---------+---------+         +-----------+-----------+          +-----------+------------+
          |                               |                                  |
          v                               v                                  v
+---------+---------+          +----------+-----------+            +---------+----------+
| Search & Ranking  |          | Trust Engine (base) |            | Payments (TON)     |
| hub_service.search|          | hub_trust_log,      |            | TONPaymentService  |
| _seller_reputation|          | trust_service (opt) |            | Escrow, Refund     |
+---------+---------+          +----------+-----------+            +---------+----------+
          |                               |                                  |
          v                               v                                  v
+---------+---------+          +----------+-----------+            +---------+----------+
| MongoDB: hub_offers|         | MongoDB: hub_trust_log|           | Future: KYC/AML    |
+--------------------+         +-----------------------+           +--------------------+

Будущие блоки: Moderation, Notifications, Analytics, Logistics, Recommenders
```


## 4. Большая схема в формате Mermaid (все внутренние и внешние элементы)

```mermaid
flowchart TD
  %% Внешние сущности
  ExtBuyer([Покупатель])
  ExtSeller([Продавец])
  ExtPeer1([Внешний узел A])
  ExtPeer2([Внешний узел B])

  %% Веб-слой
  GW[Web/API Gateway\n(CORS, Auth, RateLimit)]
  App[FastAPI App\nmain.py]
  GW --> App

  %% Роуты и протокол
  HubRoutes[/routes.hub\n/hub/inbox, /hub/search,\n/trust/score, /feeds, /tags, /categories,\n/payments: create/confirm/refund/]
  WebRoutes[/routes.web/]
  App --> HubRoutes
  App --> WebRoutes

  %% ActivityPub
  APHelpers[activitypub.py\nmake_offer, make_trust]
  HubRoutes <--> APHelpers

  %% Индексация и поиск
  HSvc[services.hub_service\nindex_offer, index_trust,\nsearch_products, replicate_to_peers]
  HubRoutes --> HSvc

  %% База данных
  subgraph DB[MongoDB]
    Offers[(hub_offers)]
    TrustLog[(hub_trust_log)]
  end
  HSvc --> Offers
  HSvc --> TrustLog

  %% Репутация
  TrustOpt[[services.trust_service\ncompute_trust_score (опц.)]]
  HSvc -.optional .-> TrustOpt

  %% Поиск
  SearchRank[[Ранжирование\nцена x доверие]]
  HSvc --> SearchRank

  %% Репликация
  HSvc -- replicate_to_peers --> ExtPeer1
  HSvc -- replicate_to_peers --> ExtPeer2

  %% Платежи TON
  TON[services.ton_payment\nTONPaymentService, confirm_delivery, request_refund]
  HubRoutes --> TON

  %% Будущие/нереализованные подсистемы
  subgraph Future[Будущие подсистемы]
    Moderation[[Модерация/Политики]]
    Notifications[[Уведомления/Webhooks]]
    Analytics[[Аналитика/Метрики]]
    Logistics[[Логистика/Исполнение]]
    Reco[[Рекомендательные модели]]
    KYC[[KYC/AML/Риск]]
  end

  App -. extensibility .-> Future

  %% Внешние акторы и потоки
  ExtSeller -->|Offer/Trust| HubRoutes
  ExtBuyer -->|Поиск/Покупка| HubRoutes
  ExtPeer1 -->|ActivityPub| HubRoutes
  ExtPeer2 -->|ActivityPub| HubRoutes
```


## 5. Примеры сценариев

### 5.1. Публикация предложения (Offer)
1) Продавец формирует ActivityPub Offer (см. `activitypub.make_offer`).
2) Отправляет на `/hub/inbox` нашего узла.
3) `hub_service.index_offer` нормализует и сохраняет в `hub_offers`.
4) `replicate_to_peers` доставляет активность на соседние хабы.

### 5.2. Доверие (Trust)
1) Участник формирует `fedmarket:Trust` (см. `activitypub.make_trust`).
2) `index_trust` сохраняет связь `source -> target` с весом в `hub_trust_log`.
3) `trust_score` агрегирует входящие веса и возвращает усреднённый скор.

### 5.3. Поиск и ранжирование
1) Запрос `/hub/search` фильтрует по тексту/тегам/цене.
2) Для каждого продавца вычисляется `_seller_reputation` (базовый/через optional trust_service).
3) Результат сортируется по комбинированному скору «цена x доверие».

### 5.4. Платёжный эскроу (TON, симулированный)
1) `/hub/payments/escrow` создаёт сделку (stub) — «заморозка средств».
2) `/hub/payments/confirm` — подтверждение доставки и разблокировка (симуляция).
3) `/hub/payments/refund` — запрос на возврат (симуляция/арбитраж).


## 6. Риски и соображения эксплуатации

| Риск | Комментарий | Митигация |
|---|---|---|
| Несогласованные политики узлов | Разные модерационные и коммерческие правила | Публичные политики, блок-листы, метаданные совместимости |
| Репликационные задержки | Асинхронная доставка, очереди | Повторная доставка, идемпотентность (upsert), ретраи |
| Оценка доверия | Манипуляции графом доверия | Нормализация весов, пороги, внешние оценщики |
| Платежные интеграции | Зависимости/доступность внешних сетей | Стаб/фоллбэк, очереди, retries, мониторинг |
| Поиск и ранжирование | Спам и SEO-манипуляции | Фильтры, штрафы, модерация, капчи |


## 7. Заключение

Ozodon демонстрирует практический каркас федеративного маркетплейса: ActivityPub для совместимости, MongoDB для индексации, гибкий поиск, граф доверия и интеграцию с TON-платежами через безопасные заглушки. Архитектурные решения (модульность, фоллбэки, федерация) позволяют масштабировать систему и постепенно добавлять новые бизнес-блоки без остановки сервиса.
